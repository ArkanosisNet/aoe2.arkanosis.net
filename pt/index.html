<!DOCTYPE html>
<html lang="en">
  <head>
    <title>AoE2 PerfectTime â€” perfect time to age up in Age of Empires II - Definitive Edition</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="en" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rev="made" href="mailto:jroquet@arkanosis.net" />
    <link rel="canonical" href="https://aoe2.arkanosis.net/pt/" />
    <style>
      * {
        color: #212529;
      }
      html {
        height: 100%;
      }
      body {
        min-height: 100%;
        margin: 0;
        padding: 0;
      }
      a {
        color: #24478f;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      header, footer {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        background-color: #eaecf0;
      }
      footer {
        bottom:0;
      }
      form {
        list-style-type: none;
      }
      form li {
        list-style-type: none;
      }
      .warning {
        padding: 15px;
        background-color: #fcf8e3;
        border-color: #faebcc;
        border-radius: 4px;
      }
      .warning, .warning strong {
        color: #8a6d3b;
      }
      .version {
          margin-bottom: 0;
          bottom: 0;
          right: 0;
          width: 100%;
          text-align:right;
      }
      table {
          text-align: left;
          width: 100%;
      }
      th, td {
          border-bottom: 1px solid #ddd;
      }
      tr:hover {
          background-color: #f5f5f5;
      }
      td span {
          text-decoration: underline dotted #24478f;
      }
    </style>
  </head>
  <body>
    <header>
      <!--<img src="logo.svg" alt="perfecttime logo" width="120" height="120" style="padding: 10px;">-->
      <div style="margin-left: 10px; padding: 10px;"><h1 style="font-size: 50px; margin:0;">AoE2 PerfectTime</h1></div>
    </header>
    <main style="padding: 10px">
      <section>
        <h2>Build order</h2>
        <form action="/query">
          <ul>
            <li><label for="civilization">Civilization</label> <select id="civilization">
              <option value="any">Any</option>
              <option value="chinese">Chinese</option>
              <option value="goth">Goth</option>
              <option value="khmer">Khmer</option>
              <option value="malay">Malay</option>
              <option value="mayan">Mayan</option>
              <option value="persian">Persian</option>
            </select></li>
            <li><label for="loom">Loom</label> <select id="loom">
              <option value="dark">In dark age</option>
              <option value="feudal">In feudal age</option>
              <option value="skip">Skip</option>
            </select></li>
            <li>
            <li><label for="sell_stone">Sell stone</label> <input type="checkbox" id="sell_stone"></li>
          </ul>
        </form>
        <p id="chinese_warning" class="warning" style="display: none;">
          Warning: with Chinese, you have to research loom first in dark age as you can't produce a villager until your have gathered enough food for it!
        </p>
        <p id="goth_warning" class="warning" style="display: none;">
          Warning: with Goths, you can research loom first in dark age as it's researched instantly!
        </p>
        <p id="khmer_warning" class="warning" style="display: none;">
          Warning: selling stone with Khmers makes your castle age time worse because you have to build a market!
        </p>
        <p id="mayan_warning" class="warning" style="display: none;">
          Warning: with Mayans you have to research loom first in dark age as you can't produce a villager until your first house is built!
        </p>
        <p id="persian_warning" class="warning" style="display: none;">
          Warning: with Persians, you'll need three villagers to build your market or you'll lose a few seconds before clicking castle age!
        </p>
      </section>
      <section>
        <h2>Perfect times</h2>
        <table id="perfect_times">
          <thead>
            <tr>
              <th><abbr title="Build Order">BO</abbr> name</th>
              <th>Villagers in dark age</th>
              <th>Perfect time to feudal age</th>
              <th>Villagers in feudal age</th>
              <th>Perfect time to castle age</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </section>
      <aside>
        <h2>Other tools to help you</h2>
        <ul>
          <li><a href="https://github.com/Arkanosis/awesome-aoe2">More tools</a></li>
        </ul>
      </aside>
      <p class="version">
        PerfectTime v0.1.0 (<a href="https://www.ageofempires.com/news/age-of-empires-ii-definitive-edition-update-66692/">DoI 71094</a>)
      </p>
    </main>
    <footer>
      <p style="width: 100%; text-align: center;">
        Made by <a href="https://arkanosis.net">Arkanosis</a>.
        Code available <a href="https://github.com/ArkanosisNet/aoe2.arkanosis.net">on GitHub</a> under the <a href="https://raw.githubusercontent.com/ArkanosisNet/aoe2.arkanosis.net/master/LICENSE">the ISC license</a>.
      </p>
    </footer>
    <script type="text/javascript">
      var table = document.getElementById('perfect_times');
      var tbody = table.getElementsByTagName('tbody')[0];
      var warning = document.getElementById('warning');
      function addRow(bo_name, villagers_dark, feudal_time, villagers_feudal, castle_time) {
        var tr = document.createElement('tr');
        var th = document.createElement('th');
        th.appendChild(document.createTextNode(bo_name));
        tr.appendChild(th);
        for (const value of [villagers_dark, feudal_time, villagers_feudal, castle_time]) {
          var td = document.createElement('td');
          td.appendChild(document.createTextNode(value));
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      function toTime(seconds) {
          return Math.floor(seconds / 60).toString().padStart(2, '0') + ':' + Math.ceil(seconds % 60).toString().padStart(2, '0');
      }
      function refresh() {
        var civilization = document.getElementById('civilization').value;
        var loom = document.getElementById('loom');
        var sell_stone = document.getElementById('sell_stone').checked;

        if (civilization == 'chinese') {
          chinese_warning.style.display = 'block';
        } else {
          chinese_warning.style.display = 'none';
        }

        if (civilization == 'goth') {
          goth_warning.style.display = 'block';
        } else {
          goth_warning.style.display = 'none';
        }

        if (civilization == 'khmer' && sell_stone) {
          khmer_warning.style.display = 'block';
        } else {
          khmer_warning.style.display = 'none';
        }

        if (civilization == 'mayan') {
          mayan_warning.style.display = 'block';
        } else {
          mayan_warning.style.display = 'none';
        }

        if (civilization == 'persian') {
          persian_warning.style.display = 'block';
        } else {
          persian_warning.style.display = 'none';
        }

        if (['chinese', 'goth', 'mayan'].indexOf(civilization) != -1) {
          loom.value = 'dark';
          loom.disabled = true;
        } else {
          loom.disabled = false;
        }

        var loom_age = loom.value;

        var start_villagers = 3;
        if (civilization == 'chinese') {
          start_villagers = 6;
        } else if (civilization == 'mayan') {
          start_villagers = 4;
        }

        var min_feudal = 24;
        if (civilization == 'khmer') {
          min_feudal = 22;
        } else if (civilization == 'malay') {
          min_feudal = 28; // TODO for a FC, use 28+2 with Malay instead of 24+2 with regular civ
        }
        if (sell_stone) {
          min_feudal -= 2; // TODO check if enough
        }
        var min_castle = 2;
        if (civilization == 'khmer' && !sell_stone) {
          min_castle = 0;
        }

        var feudal_research_speed = 1;
        if (civilization == 'malay') {
          feudal_research_speed = 1.66;
        }
        var castle_research_speed = 1;
        if (civilization == 'malay') {
          castle_research_speed = 1.66;
        } else if (civilization == 'persian') {
          castle_research_speed = 1.10;
        }

        var villager_feudal_speed = 1;
        if (civilization == 'persian') {
          villager_feudal_speed = 1.10;
        }

        var feudal_time = (min_feudal - start_villagers) * 25 + 130 / feudal_research_speed;
        if (civilization == 'chinese') {
          feudal_time += 25;
        }
        if (loom_age == 'dark' && civilization != 'goth') {
          feudal_time += 25;
        }
        var castle_time = feudal_time + min_castle * 25 / villager_feudal_speed + 160 / castle_research_speed;
        if (loom_age == 'feudal') {
          castle_time += 25;
        }

        tbody.replaceChildren();
        addRow(
         (min_feudal + 1) + ' pop' + (castle_time < 15 * 60 ? ' fast castle' : ''),
          min_feudal,
          toTime(feudal_time),
          '+' + min_castle,
          toTime(castle_time)
        );
      }
      document.querySelectorAll('input[type=checkbox],select').forEach(function(parameter) {
        parameter.addEventListener('change', refresh);
      });
      // TODO parse options from the URL fragment
      refresh();
    </script>
  </body>
</html>
